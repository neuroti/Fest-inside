<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<th:block th:replace="~{/layout/basic::setContent(~{this::content},~{this::title})}">

    <title th:fragment="title">ëŒ“ê¸€ ì‹œìŠ¤í…œ</title>


    <th:block th:fragment="content">

        <style>
            /*!* ì „ë°˜ì ì¸ ë°”ë”” ìŠ¤íƒ€ì¼ *!*/
            /*body {*/
            /*    font-family: 'Arial', sans-serif;*/
            /*    background-color: #f4f7fc;*/
            /*    color: #333;*/
            /*    margin: 0;*/
            /*    padding: 0;*/
            /*}*/

            /*!* ëŒ“ê¸€ ëª©ë¡ ì˜ì—­ *!*/
            /*#reviews-section {*/
            /*    background-color: #fff;*/
            /*    border-radius: 8px;*/
            /*    padding: 20px;*/
            /*    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);*/
            /*    margin-bottom: 30px;*/
            /*    max-width: 800px;*/
            /*    margin: 20px auto;*/
            /*}*/

            /*#reviews-section h4 {*/
            /*    font-size: 24px;*/
            /*    margin-bottom: 15px;*/
            /*    color: #333;*/
            /*}*/

            /*#reviews-list {*/
            /*    list-style: none;*/
            /*    padding: 0;*/
            /*}*/

            /*#reviews-list li {*/
            /*    background-color: #f9f9f9;*/
            /*    position: relative;*/
            /*    padding: 15px;*/
            /*    margin-bottom: 10px;*/
            /*    border-radius: 8px;*/
            /*    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);*/
            /*    display: flex;*/
            /*    flex-direction: column;*/
            /*    !*justify-content: space-between;*!*/
            /*    !*align-items: center;*!*/
            /*    padding-top: 30px;*/
            /*}*/


            /*#reviews-list li p {*/
            /*    margin: 0;*/
            /*    flex-grow: 1;*/
            /*    font-size: 16px;*/
            /*    color: #555;*/
            /*    margin-top: 40px;*/
            /*}*/

            /*!* ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ *!*/
            /*#reviews-list li button {*/
            /*    background-color: #ffb6c1;*/
            /*    color: #fff;*/
            /*    border: none;*/
            /*    padding: 4px 6px;*/
            /*    font-size: 14px;*/
            /*    border-radius: 3px;*/
            /*    cursor: pointer;*/
            /*    margin-left: 20px;*/
            /*    transition: background-color 0.3s;*/
            /*    top: 5px; !* ìƒë‹¨ì—ì„œ 5px *!*/
            /*    right: 5px; !* ìš°ì¸¡ì—ì„œ 5px *!*/
            /*    width: 50px; !* ë²„íŠ¼ì˜ ê³ ì • í¬ê¸° *!*/
            /*    height: 30px; !* ë²„íŠ¼ì˜ ê³ ì • ë†’ì´ *!*/
            /*}*/

            /*!* ìˆ˜ì • ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • *!*/
            /*#reviews-list li button.modify-btn {*/
            /*    right: 62px; !* ìˆ˜ì • ë²„íŠ¼ì´ ì‚­ì œ ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ìš°ì¸¡ì—ì„œ 90pxë¡œ ìœ„ì¹˜ ì´ë™ *!*/
            /*}*/

            /*#reviews-list li button:hover {*/
            /*    background-color: #fd999e;*/
            /*}*/

            /*!* ëŒ“ê¸€ ì¶”ê°€ ì˜ì—­ *!*/
            /*#add-review-section {*/
            /*    max-width: 800px;*/
            /*    margin: 0 auto;*/
            /*    background-color: #fff;*/
            /*    border-radius: 8px;*/
            /*    padding: 20px;*/
            /*    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);*/
            /*}*/

            /*#review-content {*/
            /*    width: 100%;*/
            /*    padding: 10px;*/
            /*    border-radius: 8px;*/
            /*    border: 1px solid #ddd;*/
            /*    font-size: 16px;*/
            /*    resize: vertical;*/
            /*    box-sizing: border-box;*/
            /*    margin-bottom: 15px;*/
            /*    transition: border-color 0.3s;*/
            /*    background-color: #f7f7f7;*/
            /*}*/

            /*#review-content:focus {*/
            /*    border-color: #ffb6c1;*/
            /*    outline: none;*/
            /*}*/

            /*#add-review-button {*/
            /*    background-color: #ffb6c1;*/
            /*    color: #fff;*/
            /*    border: none;*/
            /*    padding: 10px 20px;*/
            /*    font-size: 16px;*/
            /*    border-radius: 5px;*/
            /*    cursor: pointer;*/
            /*    width: 100%;*/
            /*    transition: background-color 0.3s;*/
            /*}*/

            /*#add-review-button:hover {*/
            /*    background-color: #fd999e;*/
            /*}*/

            /*!* ë³„ì  ìŠ¤íƒ€ì¼ *!*/
            /*.stars {*/
            /*    position: absolute;*/
            /*    top: 5px;*/
            /*    left: 10px;*/
            /*    display: flex;*/
            /*    gap: 2px; !* ë³„ ê°„ê²© *!*/
            /*}*/

            /*.stars i {*/
            /*    font-size: 16px;*/
            /*    color: #FFD700; !* ê¸ˆìƒ‰ *!*/
            /*}*/

            /*!* ë³„ì  ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ *!*/
            /*.rating {*/
            /*    display: flex;*/
            /*    gap: 5px; !* ë³„ ê°„ê²© *!*/
            /*}*/

            /*.rating i {*/
            /*    font-size: 16px; !* ë³„ í¬ê¸° *!*/
            /*    color: #FFD700; !* ê¸°ë³¸ ìƒ‰ì€ íšŒìƒ‰ *!*/
            /*    cursor: pointer;*/
            /*    transition: color 0.2s ease-in-out;*/
            /*}*/

            /*.edit-stars {*/
            /*    cursor: pointer;*/
            /*    color: #f39c12;*/
            /*    animation: pulse 1s infinite alternate;*/
            /*}*/

            /*@keyframes pulse {*/
            /*    0% {*/
            /*        transform: scale(1);*/
            /*    }*/
            /*    100% {*/
            /*        transform: scale(1.1);*/
            /*    }*/
            /*}*/

            /*textarea {*/
            /*    width: 100%; !* í…ìŠ¤íŠ¸ ì˜ì—­ ë„ˆë¹„ *!*/
            /*    padding: 10px;*/
            /*    font-size: 16px;*/
            /*    border: 1px solid #ccc;*/
            /*    margin-top: 10px;*/
            /*}*/

            /*button {*/
            /*    padding: 10px 15px;*/
            /*    color: white;*/
            /*    border: none;*/
            /*    margin-top: 10px;*/
            /*    cursor: pointer;*/
            /*}*/

            /*!* ì‘ì€ í™”ë©´ì— ëŒ€í•œ ë°˜ì‘í˜• *!*/
            /*@media (max-width: 768px) {*/
            /*    #reviews-section, #add-review-section {*/
            /*        padding: 15px;*/
            /*    }*/

            /*    #review-content {*/
            /*        font-size: 14px;*/
            /*    }*/

            /*    #add-review-button {*/
            /*        font-size: 14px;*/
            /*    }*/

            /*    #reviews-list li {*/
            /*        flex-direction: column;*/
            /*        align-items: flex-start;*/
            /*    }*/

            /*    #reviews-list li button {*/
            /*        margin-top: 10px;*/
            /*        width: 100%;*/
            /*    }*/
            /*}*/

            /*.load-more-btn {*/
            /*    display: block; !* ë²„íŠ¼ì„ ì¤‘ì•™ìœ¼ë¡œ ì •ë ¬í•˜ê¸° ìœ„í•´ block ì†ì„± *!*/
            /*    margin: 10px auto; !* ìë™ìœ¼ë¡œ ì¢Œìš° ì—¬ë°± ë°°ì¹˜ *!*/
            /*    padding: 8px 16px;*/
            /*    background-color: #007bff;*/
            /*    color: white;*/
            /*    border: none;*/
            /*    border-radius: 4px;*/
            /*    cursor: pointer;*/
            /*    font-size: 14px;*/
            /*}*/

            /*.load-more {*/
            /*    text-align: center;*/
            /*}*/


            /* ê¸°ë³¸ CSS ìŠ¤íƒ€ì¼ */
            body {
                font-family: Arial, sans-serif;
                background-color: #f9f9f9;
                margin: 0;
                padding: 0;
            }

            /* ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
            #reviews-list {
                list-style: none;
                margin: 0;
                padding: 0;
            }

            .review-item {
                padding: 10px;
                border: 1px solid #ddd;
                margin-bottom: 10px;
                border-radius: 5px;
                background-color: #f9f9f9;
                position: relative;
            }


            /* ë³„ì  ìœ„ì¹˜ */
            .stars {
                display: inline-block;
                font-size: 14px;
                color: #f1c40f;
            }

            /* ëŒ“ê¸€ í—¤ë” ìŠ¤íƒ€ì¼ */
            .review-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 5px;
            }

            .review-author {
                font-weight: bold;
                font-size: 14px;
            }

            .review-timestamp {
                font-size: 12px;
                color: #888;
                margin-left: 10px;
            }

            /* ëŒ“ê¸€ ë‚´ìš© ìŠ¤íƒ€ì¼ */
            .review-content {
                margin-bottom: 10px;
                line-height: 1.5;
            }

            /* ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ìœ„ì¹˜ */
            .review-actions {
                text-align: right;
                margin-top: 5px;
            }


            .modify-btn, .delete-btn, .reply-btn {
                background-color: #007bff;
                border: none;
                border-radius: 3px;
                color: #fff;
                cursor: pointer;
                padding: 5px 10px;
                font-size: 0.9em;
            }

            .modify-btn:hover, .delete-btn:hover, .reply-btn:hover {
                background-color: #0056b3;
            }

            /* ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
            .replies-list {
                list-style: none;
                margin-top: 10px;
                padding-left: 20px;
            }

            .reply-item {
                padding: 5px;
                border: 1px solid #ddd;
                margin-bottom: 5px;
                margin-left: 20px;
                background-color: #fff;
                position: relative;
                border-radius: 3px;
            }

            .reply-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 5px;
            }

            .reply-author {
                font-weight: bold;
                font-size: 12px;
            }

            .reply-timestamp {
                font-size: 12px;
                color: #888;
                margin-left: 10px;
            }

            .reply-actions {
                text-align: right;
                margin-top: 5px;
            }

            .reply-content {
                font-size: 13px;
                margin-bottom: 5px;
            }

            /* ë”ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            .load-more-btn {
                background-color: #f1c40f;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                cursor: pointer;
            }

            .load-more-btn:hover {
                background-color: #d4ac0d;
            }


            /* ëŒ€ëŒ“ê¸€ ì…ë ¥ë€ ìŠ¤íƒ€ì¼ */
            .reply-input {
                display: flex;
                align-items: center;
                margin-top: 10px;
            }

            .reply-textarea {
                flex-grow: 1;
                height: 40px;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 5px;
                margin-right: 10px;
            }


            .submit-reply-btn {
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                cursor: pointer;
            }

            .submit-reply-btn:hover {
                background-color: #2980b9;
            }

        </style>


        <body>
            <div id="reviews-section">
                <div>
                    <span id="currentUserName" th:text="${idName}" style="display: none;"></span>
                </div>
                <div class="review-summary">
                    <span th:text="'â­ í‰ê·  ë³„ì : ' + ${avgRating}">â­ í‰ê·  ë³„ì : 0.0</span>
                    <span th:text="'ğŸ’¬ ëŒ“ê¸€ ìˆ˜: ' + ${reviewCount}">ğŸ’¬ ëŒ“ê¸€ ìˆ˜: 0</span>
                </div>
                <h3>ì¶•ì œì˜ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</h3>
                <ul id="reviews-list"></ul>
            </div>

            <div id="add-review-section">
                <div id="star-rating" class="rating">
                    <i class="far fa-star" data-value="1"></i>
                    <i class="far fa-star" data-value="2"></i>
                    <i class="far fa-star" data-value="3"></i>
                    <i class="far fa-star" data-value="4"></i>
                    <i class="far fa-star" data-value="5"></i>
                </div>
                <textarea id="review-content" rows="5" cols="80" placeholder="í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
                <button id="add-review-button">ë“±ë¡</button>
            </div>
        </body>

        <script>
            // URLì—ì„œ boardId ì¶”ì¶œ
            const url = window.location.pathname; // ì˜ˆ: "/festival/details/3"
            const boardId = url.split('/').pop(); // "3"


            let selectedRating = 0;
            let isEditingRe = {};
            let isEditingRre = {};

            // ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ í•¨ìˆ˜
            function fetchReviews() {

                const currentUser = document.getElementById('currentUserName').textContent.trim(); // ìˆ¨ê²¨ì§„ ê°’ ê°€ì ¸ì˜¤ê¸°
                console.log("í˜„ì¬ ì‚¬ìš©ì:", currentUser);

                $.get(`/festival/review/get/${boardId}`, function(data) {
                    const reviewsList = $("#reviews-list");
                    reviewsList.empty();

                    if (data.reviews && data.reviews.length > 0) {
                        data.reviews.forEach(review => {
                            const stars = generateStars(review.rating);
                            const isOwnReview = review.author === currentUser; // ì‘ì„±ìì™€ í˜„ì¬ ì‚¬ìš©ìê°€ ê°™ì€ì§€ í™•ì¸

                            reviewsList.append(`
                    <li id="review-${review.reviewId}" class="review-item">
                        <div class="review-header">
                            <span class="review-author">${review.author}</span>
                            <span class="review-timestamp">${review.regDate}</span>
                        </div>
                        <div class="stars" data-review-id="${review.reviewId}" data-rating="${review.rating}">${stars}</div>
                        <div class="review-content">${review.content}</div>
                        <div class="review-actions">
                            ${isOwnReview ? `
                                <button class="modify-btn" data-review-id="${review.reviewId}" data-content="${review.content}">ìˆ˜ì •</button>
                                <button class="delete-btn" data-review-id="${review.reviewId}">ì‚­ì œ</button>
                            ` : ''}
                            <button class="reply-btn" data-review-id="${review.reviewId}">ë‹µê¸€ì“°ê¸°</button>
                        </div>
                        <ul class="replies-list" id="replies-${review.reviewId}"></ul>
                    </li>
                `);
                            fetchReplies(review.reviewId); // ì²« í˜ì´ì§€ ëŒ€ëŒ“ê¸€ ë¡œë“œ
                        });

                        $(".modify-btn").on("click", function() {
                            const reviewId = $(this).data("review-id");
                            handleModifyButtonClick(reviewId);
                        });

                        $(".delete-btn").on("click", function() {
                            const reviewId = $(this).data("review-id");
                            deleteReview(reviewId);
                        });

                        $(".reply-btn").on("click", function() {
                            const reviewId = $(this).data("review-id");
                            openReplyInput(reviewId); // ë‹µê¸€ ì…ë ¥ì°½ ì—´ê¸°
                        });
                    } else {
                        reviewsList.append("<li>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>");
                    }
                }).fail(function() {
                    alert("ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            }


            // íŠ¹ì • ë¦¬ë·°ì— ì—°ê²°ëœ ëŒ€ëŒ“ê¸€ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function fetchReplies(rootNum) {
                const currentUser = document.getElementById('currentUserName').textContent.trim(); // ìˆ¨ê²¨ì§„ ê°’ ê°€ì ¸ì˜¤ê¸°

                $.get(`/festival/review/view/${rootNum}`, function (data) {
                    const repliesList = $(`#replies-${rootNum}`);
                    repliesList.empty();

                    if (data.replies && data.replies.length > 0) {
                        data.replies.forEach((reply, index) => {
                            const isOwnReply = reply.author === currentUser; // ì‘ì„±ìì™€ í˜„ì¬ ì‚¬ìš©ì ë¹„êµ
                            console.log(isOwnReply)
                            const isHidden = index >= 5 ? 'style="display:none;"' : '';

                            repliesList.append(`
                            <li id="reply-${reply.reviewId}" class="reply-item" ${isHidden}>
                                <div class="reply-header">
                                    <span class="reply-author">${reply.author}</span>
                                    <span class="reply-timestamp">${reply.regDate}</span>
                                </div>
                                <div class="reply-content">${reply.content}</div>
                                <div class="reply-actions">
                                    ${isOwnReply ? `
                                        <button class="reply-modify-btn" data-reply-id="${reply.reviewId}">ìˆ˜ì •</button>
                                        <button class="reply-delete-btn" data-reply-id="${reply.reviewId}">ì‚­ì œ</button>
                                    ` : ''}
                                </div>
                            </li>
                        `);
                        });

                        $(".reply-modify-btn").on("click", function () {
                            const replyId = $(this).data("reply-id");
                            console.log(replyId)
                            handleReplyModifyButtonClick(replyId);
                        });

                        $(".reply-delete-btn").on("click", function () {
                            const replyId = $(this).data("reply-id");
                            console.log(replyId)
                            deleteReview(replyId);
                        });
                if (data.replies.length > 5) {
                    repliesList.append(`
                    <li class="load-more" style="text-align: center;">
                        <button class="load-more-btn" onclick="toggleReplies('${rootNum}', this)">ë”ë³´ê¸°</button>
                    </li>
                    `);

                }
                }else {
                        repliesList.append("<li>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>");
                }
                }).fail(function () {
                    alert("ëŒ“ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });

            }


            //ë”ë³´ê¸° í† ê¸€ í•¨ìˆ˜
            function toggleReplies(rootNum, button) {
                const repliesList = $(`#replies-${rootNum}`);
                const hiddenReplies = repliesList.find("li[style='display:none;']");

                if (hiddenReplies.length > 0) {
                    hiddenReplies.show();
                    button.textContent = "ì ‘ê¸°";
                }//ìˆ¨ê²¨ì§„ ëŒ€ëŒ“ê¸€ì´ ìˆìœ¼ë©´~~ ë
                else {
                    repliesList.find(".reply-item").slice(5).hide(); //5ê°œ ì´í›„ ë‹¤ì‹œ ìˆ¨ê¹€
                    button.textContent = "ë”ë³´ê¸°";
                    fetchReplies(rootNum)
                } //ì—†ìœ¼ë©´ ~~~ ë
            } //toggleí•¨ìˆ˜ ë—

            // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§· í•¨ìˆ˜
            function formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
            }

            // ë‹µê¸€ ì…ë ¥ì°½ ì—´ê¸° í•¨ìˆ˜
            function openReplyInput(reviewId) {
                const repliesList = $(`#replies-${reviewId}`);

                if (repliesList.find(".reply-input").length > 0) {
                    return;
                }
                repliesList.append(`
                    <li class="reply-input">
                        <textarea class="reply-textarea" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        <button class="submit-reply-btn" data-review-id="${reviewId}">ë“±ë¡</button>
                    </li>
                `);

                repliesList.find(".submit-reply-btn").on("click", function() {
                    const content = $(this).siblings(".reply-textarea").val();
                    if (content.trim() === "") {
                        alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                        return;
                    }

                    // ë‹µê¸€ ë“±ë¡ ìš”ì²­
                    $.ajax({
                        url: `/festival/review/reply/${reviewId}`,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({content: content}),
                        success: function () {
                            fetchReplies(reviewId);
                            alert("ë‹µê¸€ì„ ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.")
                        }, //ì„±ê³µì‹œì—~~
                        error: function () {
                            alert("ë‹µê¸€ ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.")
                        }
                    })//ajax ë
                });
            }

            // ëŒ“ê¸€ ì¶”ê°€ í•¨ìˆ˜
            $("#add-review-button").on("click", function() {
                const content = $("#review-content").val();


                if (!content.trim()) {
                    alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                if(selectedRating === 0){
                    alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                $.ajax({
                    url: `/festival/review/add/${boardId}`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        content: content,
                        rating: selectedRating
                    }),
                    success: function() {
                        alert("ëŒ“ê¸€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        $("#review-content").val(""); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                        resetStars();
                        fetchReviews(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    },
                    error: function(err) {
                        alert(err.responseJSON?.message || "ëŒ“ê¸€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
                location.reload();
            });

            // ëŒ“ê¸€ ì‚­ì œ í•¨ìˆ˜
            function deleteReview(reviewId) {

                console.log(reviewId);


                if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    $.ajax({
                        url: `/festival/review/delete/${reviewId}`,
                        method: "DELETE",
                        success: function() {
                            alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            fetchReviews();
                        },
                        error: function(err) {
                            console.log(err);
                            alert(err.responseJSON?.message || "ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }

                location.reload();
            }


            function deleteReply(replyId) {

                console.log(replyId)

                if (confirm("ì •ë§ë¡œ ëŒ€ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    $.ajax({
                        url: `/festival/review/delete/${replyId}`,
                        method: "DELETE",
                        success: function () {
                            alert("ëŒ€ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            $(`#reply-${replyId}`).remove(); // ì‚­ì œëœ ëŒ€ëŒ“ê¸€ UIì—ì„œ ì œê±°
                        },
                        error: function (err) {
                            alert(err.responseJSON?.message || "ëŒ€ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
            }


            // ëŒ“ê¸€ ìˆ˜ì • í•¨ìˆ˜
            function handleModifyButtonClick(reviewId) {

                const starsDiv = $(`#review-${reviewId} .stars`);
                const contentP = $(`#review-${reviewId} .review-content`);
                const modifyButton = $(`#review-${reviewId} .modify-btn`);

                if (!isEditingRe[reviewId]) {
                    isEditingRe[reviewId] = true;

                    let currentRating = starsDiv.data("rating") || 0;
                    const currentContent = modifyButton.data("content");
                    console.log(currentContent)


                    starsDiv.html(generateStars(currentRating)); // ê¸°ì¡´ ë³„ì  í‘œì‹œ

                    starsDiv.find("i").on("click", function () {
                        const newRating = $(this).index() + 1; // í´ë¦­í•œ ë³„ì  ê°’
                        updateStarsForReview(reviewId, newRating);
                    });

                    const contentInput = $(`<textarea class="content-input" rows="3">${currentContent}</textarea>`);
                    contentP.replaceWith(contentInput);

                    modifyButton.text("ìˆ˜ì •")

                } else {

                    const newRating = starsDiv.data("rating") || 0;
                    const newContent = $(`#review-${reviewId} .content-input`).val();


                    if (!newContent.trim()) {
                        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    if (newRating === 0) {
                        alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                        return;
                    }


                    $.ajax({
                        url: `/festival/review/modify/${reviewId}`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({
                            content: newContent,
                            rating: newRating
                        }),
                        success: function () {
                            alert("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                            isEditingRe[reviewId] = false
                            fetchReviews();
                        },
                        error: function (err) {
                            alert(err.responseJSON?.message || "ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            isModifying = false;
                        }
                    });
                }

                location.reload();
            }

        function handleReplyModifyButtonClick(replyId) {
                const replyContentDiv = $(`#reply-${replyId} .reply-content`);
                const modifyButton = $(`#reply-${replyId} .reply-modify-btn`);

                if (!isEditingRre[replyId]) {
                    isEditingRre[replyId] = true;

                    const currentContent = replyContentDiv.text().trim();
                    const contentInput = $(`<textarea class="reply-content-input" rows="2">${currentContent}</textarea>`);

                    replyContentDiv.replaceWith(contentInput);
                    modifyButton.text("ì €ì¥");
                } else {
                    const newContent = $(`#reply-${replyId} .reply-content-input`).val();

                    if (!newContent.trim()) {
                        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    $.ajax({
                        url: `/festival/review/modify/${replyId}`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({
                            content: newContent
                        }),
                        success: function () {
                            alert("ëŒ€ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            isEditingRre[replyId] = false;
                            fetchReplies(replyId); // ìˆ˜ì •ëœ ëŒ€ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                        },
                        error: function (err) {
                            alert(err.responseJSON?.message || "ëŒ€ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            isEditingRre[replyId] = false;
                        }
                    });
                }
            location.reload();
        }


            function updateStarsForReview(reviewId, rating){
                const starsDiv = $(`#review-${reviewId} .stars`);
                starsDiv.data("rating", rating);
                starsDiv.html(generateStars(rating));
                starsDiv.addClass("edit-stars");

                starsDiv.find("i").on("click", function (){
                    const newRating = $(this).index() + 1;
                    starsDiv.data("rating", newRating);
                    starsDiv.html(generateStars(newRating));
                    updateStarsForReview(reviewId, newRating);
                });

            }


            function resetStars(){
                selectedRating = 0;
                $("star-rating i").removeClass("fas").addClass("far")
            }

            function updateStars(rating){
                selectedRating = rating
                $("#star-rating i").each(function (index){
                    $(this).toggleClass("fas", index < rating)
                    $(this).toggleClass("far", index >= rating)
                })
            }

            $("#star-rating i").on("click", function() {
                const rating = $(this).data("value");
                updateStars(rating);
            });


            function generateStars(rating) {
                const maxStars = 5; // ë³„ì ì˜ ìµœëŒ€ê°’
                const fullStar = '<i class="fas fa-star"></i>'; // ê½‰ ì°¬ ë³„
                const emptyStar = '<i class="far fa-star"></i>'; // ë¹ˆ ë³„

                let stars = '';

                // ê½‰ ì°¬ ë³„ ì¶”ê°€
                for (let i = 0; i < Math.floor(rating); i++) {
                    stars += fullStar;
                }

                // ë¹ˆ ë³„ ì¶”ê°€
                for (let i = Math.floor(rating); i < maxStars; i++) {
                    stars += emptyStar;
                }

                return stars;
            }

            const avgRatingElement = document.querySelector(".review-summary span:nth-child(1)");
            const reviewCountElement = document.querySelector(".review-summary span:nth-child(2)");

            async function fetchReviewSummary() {
                // URLì—ì„œ boardId ì¶”ì¶œ
                const url = window.location.pathname; // ì˜ˆ: "/festival/details/3"
                const boardId = url.split('/').pop(); // "3"
                try {

                    const response = await  fetch(`/festival/review/about/${boardId}`)
                    const data = await response.json();

                    avgRatingElement.textContent = `â­ í‰ê·  ë³„ì : ${data.avgRating}`
                    reviewCountElement.textContent = `ğŸ’¬ ëŒ“ê¸€ ìˆ˜: ${data.reviewCount}`

                } catch (error){
                    console.error("ë¦¬ë·° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒ", error)
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                fetchReviewSummary(boardId)
            });

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            $(document).ready(function() {
                fetchReviews();
                fetchReviewSummary();

            });


        </script>
    </th:block>
</th:block>

